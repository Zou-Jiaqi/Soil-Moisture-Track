name: Build and Deploy SMAP Preprocess
run-name: ${{ github.actor }} is building and deploying SMAP preprocess. ðŸš€
on:
  push:
    branches: [ "main" ]
    paths:
      - "preprocess/smap/**"
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Airflow
    env:
      PROJECT_ID: secure-bonbon-463900-u2
      REGION: us-west2
      IMAGE_NAME: us-west2-docker.pkg.dev/secure-bonbon-463900-u2/soil-moisture-track/smap_preprocess
      JOB_NAME: smap-preprocess-job
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-west2-docker.pkg.dev --quiet

      - name: Build and Push Docker Image
        working-directory: ./preprocess/smap
        run: |
          docker buildx build \
            -f ./Dockerfile \
            -t ${IMAGE_NAME}:latest \
            -t ${IMAGE_NAME}:${{ github.sha }} \
            --platform linux/amd64 \
            --push \
            .

      - name: Deploy to Cloud Run Job
        run: |
          if gcloud run jobs describe ${JOB_NAME} --region=${REGION} --project=${PROJECT_ID} &>/dev/null; then
            echo "Updating existing Cloud Run Job..."
            gcloud run jobs update ${JOB_NAME} \
              --image=${IMAGE_NAME}:latest \
              --region=${REGION} \
              --project=${PROJECT_ID}
              
          else
            echo "Creating new Cloud Run Job..."
            gcloud run jobs create ${JOB_NAME} \
              --image=${IMAGE_NAME}:latest \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --max-retries=3 \
              --task-timeout=3600 \
              --memory=2Gi \
              --cpu=2
          fi
