name: Build and Deploy Airflow Service
run-name: ${{ github.actor }} is building and deploying Airflow service. ðŸš€
on:
  push:
    branches: [ "main" ]
    paths:
      - "airflow/**"
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Airflow
    env:
      PROJECT_ID: "${{ vars.GCP_PROJECT_ID }}"
      REGION: "${{ vars.GCP_REGION }}" 
      CYGNSS_INGEST_JOB_NAME: "${{ vars.CYGNSS_INGEST_JOB_NAME }}"
      SMAP_INGEST_JOB_NAME: "${{ vars.SMAP_INGEST_JOB_NAME }}"
      CYGNSS_PREPROCESS_JOB_NAME: "${{ vars.CYGNSS_PREPROCESS_JOB_NAME }}"
      SMAP_PREPROCESS_JOB_NAME: "${{ vars.SMAP_PREPROCESS_JOB_NAME }}"
      INTEGRATION_JOB_NAME: "${{ vars.INTEGRATION_JOB_NAME }}"
      SMT_REGISTRY_NAME: "${{ vars.SMT_REGISTRY_NAME }}"
      AIRFLOW_SERVICE_NAME: "${{ vars.AIRFLOW_SERVICE_NAME }}"
      ARTIFACT_DOMAIN: "${{REGION}}-docker.pkg.dev"
      IMAGE_NAME: "${{ARTIFACT_DOMAIN}}/${{PROJECT_ID}}/${{SMT_REGISTRY_NAME}}/${{AIRFLOW_SERVICE_NAME}}"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${ARTIFACT_DOMAIN} --quiet

      - name: Build and Push Docker Image
        working-directory: ./airflow
        run: |
          docker buildx build \
            --build-arg PROJECT_ID=${PROJECT_ID} \
            --build-arg REGION=${REGION} \
            --build-arg CYGNSS_INGEST_JOB_NAME=${CYGNSS_INGEST_JOB_NAME} \
            --build-arg SMAP_INGEST_JOB_NAME=${SMAP_INGEST_JOB_NAME} \
            --build-arg CYGNSS_PREPROCESS_JOB_NAME=${CYGNSS_PREPROCESS_JOB_NAME} \
            --build-arg SMAP_PREPROCESS_JOB_NAME=${SMAP_PREPROCESS_JOB_NAME} \
            --build-arg INTEGRATION_JOB_NAME=${INTEGRATION_JOB_NAME} \
            -f ./Dockerfile \
            -t ${IMAGE_NAME}:latest \
            -t ${IMAGE_NAME}:${{ github.sha }} \
            --platform linux/amd64 \
            --push \
            .

      - name: Deploy to Cloud Run Service
        run: |
          # Check if service exists
          if gcloud run services describe ${AIRFLOW_SERVICE_NAME} --region=${REGION} --project=${PROJECT_ID} &>/dev/null; then
            echo "Updating existing Cloud Run Service..."
            gcloud run services update ${AIRFLOW_SERVICE_NAME} \
              --image=${IMAGE_NAME}:latest \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --memory=8Gi \
              --cpu=2 \
              --min-instances=1 \
              --max-instances=1 \
              --port=8080 
          else
            echo "Creating new Cloud Run Service..."
            gcloud run services create ${AIRFLOW_SERVICE_NAME} \
              --image=${IMAGE_NAME}:latest \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --memory=8Gi \
              --cpu=2 \
              --min-instances=1 \
              --max-instances=1 \
              --port=8080 
          fi
