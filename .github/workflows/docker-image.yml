name: Build and Deploy Airflow Service
run-name: ${{ github.actor }} is building and deploying Airflow service. ðŸš€
on:
  push:
    branches: [ "main" ]
    paths:
      - "airflow/**"
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Airflow
    env:
      GSC_BUCKET_NAME: "${{vars.GSC_BUCKET_NAME}}"
      UPLOAD_PATH_SMAP_RAW: "${{vars.GSC_BUCKET_NAME}}${{vars.BUCKET_PATH_RAW_SMAP}}"
      UPLOAD_PATH_CYGNSS_RAW: "${{vars.GSC_BUCKET_NAME}}${{vars.BUCKET_PATH_RAW_CYGNSS}}"
      UPLOAD_PATH_PARQUET: "${{vars.GSC_BUCKET_NAME}}${{vars.BUCKET_PATH_PARQUET}}"
      IMAGE_NAME: us-west2-docker.pkg.dev/secure-bonbon-463900-u2/soil-moisture-track/smt_airflow
      PROJECT_ID: secure-bonbon-463900-u2
      REGION: us-west2
      SERVICE_NAME: smt-airflow
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-west2-docker.pkg.dev --quiet

      - name: Build and Push Docker Image
        working-directory: ./airflow
        run: |
          docker buildx build \
            --build-arg GSC_BUCKET_NAME=${GSC_BUCKET_NAME} \
            --build-arg UPLOAD_PATH_SMAP_RAW=${UPLOAD_PATH_SMAP_RAW} \
            --build-arg UPLOAD_PATH_CYGNSS_RAW=${UPLOAD_PATH_CYGNSS_RAW} \
            --build-arg UPLOAD_PATH_PARQUET=${UPLOAD_PATH_PARQUET} \
            -f ./Dockerfile \
            -t ${IMAGE_NAME}:latest \
            -t ${IMAGE_NAME}:${{ github.sha }} \
            --platform linux/amd64 \
            --push \
            .

      - name: Deploy to Cloud Run Service
        run: |
          # Check if service exists
          if gcloud run services describe ${SERVICE_NAME} --region=${REGION} --project=${PROJECT_ID} &>/dev/null; then
            echo "Updating existing Cloud Run Service..."
            gcloud run services update ${SERVICE_NAME} \
              --image=${IMAGE_NAME}:latest \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --memory=8Gi \
              --cpu=2 \
              --min-instances=1 \
              --max-instances=1 \
              --port=8080 \
              --allow-unauthenticated
          else
            echo "Creating new Cloud Run Service..."
            gcloud run services create ${SERVICE_NAME} \
              --image=${IMAGE_NAME}:latest \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --memory=8Gi \
              --cpu=2 \
              --min-instances=1 \
              --max-instances=1 \
              --port=8080 \
              --allow-unauthenticated
          fi
